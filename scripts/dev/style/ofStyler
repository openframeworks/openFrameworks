#! /bin/bash
#
# this script runs uncrustify on a given file or dir of files using the OF style config file
#
# the style file was created using Universal Indent GUI following the OF coding guidelines:
# https://github.com/openframeworks/openFrameworks/wiki/oF-code-style
#
# 2012 Dan Wilcox <danomatika@gmail.com> for openFrameworks
#
# adapted from the call_Uncrustify.sh script generated by Universal Indent GUI
#

# exit this script on an error
#set -e

# the uncrustify style file
CONFIG_FILE=openFrameworks_style.cfg

# comment this for debug output
QUIET=-q

###

function printUsage() {
	echo
	echo "Usage:"
	echo "	ofStyler dirname filesuffix"
	echo "	ofStyler filename"
	echo
	echo "Example:"
	echo "	ofStyler ../../../libs/openFrameworks cpp"
	echo "	ofStyler myFile.cpp"
	echo
}

function commandExists() {
	hash "$1" 2>&-
}

###

# is uncrustify installed?
if ! commandExists uncrustify ; then
	echo
	echo "ERROR: uncrustify source code formatter not found!"
	echo
	echo "please install uncrustify: http://uncrustify.sourceforge.net/"
	echo "  Mac OSX:"
	echo "    homebrew: brew install uncrustify"
	echo "    macports: sudo port install uncrustify"
	echo "  Ubuntu:"
	echo "    sudo apt-get install uncrustify"
	echo "  Windows:"
	echo "    http://sourceforge.net/projects/uncrustify/files/uncrustify/"
	echo
	exit 1
fi

# get the current working dir
SCRIPT_DIR=$(dirname $0)

# got any options?
if [ ! -n "$1" ]; then
	printUsage
	exit 1
fi

# simple check for help flags
if [ "$1" == "-h" -o "$1" == "--help" ]; then
	printUsage
	exit 0
fi

# recurse through a dir
if [ -d "$1" ]; then
	
	#echo "Dir ${1} exists"
	
	if [ -n "$2" ]; then
		filesuffix=$2
	else
		filesuffix="*"
	fi

	#echo "Filtering files using suffix ${filesuffix}"

	file_list=`find ${1} -name "*.${filesuffix}" -type f`
	for file2indent in $file_list; do 
		echo "Styling file $file2indent"
		uncrustify $QUIET "$file2indent" -c $SCRIPT_DIR/$CONFIG_FILE --no-backup
	done

else
	
	# style a single given file
	if [ -f "$1" ]; then
		echo "Styling one file $1"
		uncrustify $QUIET "$1" -c $SCRIPT_DIR/$CONFIG_FILE --no-backup
	else
		echo
		echo "ERROR: directory or file $1 does not exist!"
		printUsage
		exit 1
	fi
fi
